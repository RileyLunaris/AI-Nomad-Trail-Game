<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 2025 AI Nomad Trail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .stat-bar { height: 1.5rem; border-radius: 0.5rem; overflow: hidden; }
        .stat-fill { transition: width 0.5s; }
        #game-area { min-height: 80vh; }
    </style>
</head>
<body>
    <div id="game-area" class="p-4 md:p-8"></div>

    <script>
// Game Configuration
const START_CITY = "New York City, NY";
const END_CITY = "San Francisco, CA";
const TOTAL_DISTANCE = 3000;
const PROFESSIONS = [
    { name: "AI Prompt Engineer", cash: 3500, laptop: 100, mental: 90, description: "High income, high burnout risk." },
    { name: "Content Creator", cash: 2500, laptop: 95, mental: 100, description: "Flexible schedule, unpredictable income." },
    { name: "DevOps Consultant", cash: 3000, laptop: 100, mental: 100, description: "Stable income, heavy reliance on equipment." }
];

class Player {
    constructor(professionName) {
        const professionData = PROFESSIONS.find(p => p.name === professionName) || PROFESSIONS[0];
        this.profession = professionName;
        this.distance = 0;
        this.cash = professionData.cash;
        this.laptop_health = professionData.laptop;
        this.mental_health = professionData.mental;
        this.is_alive = true;
        this.game_over_reason = "";
    }

    clamp(value, min, max) { return Math.max(min, Math.min(max, value)); }

    applyEffect(cash, laptop, mental, outcomeText) {
        this.cash += cash;
        this.laptop_health = this.clamp(this.laptop_health + laptop, 0, 100);
        this.mental_health = this.clamp(this.mental_health + mental, 0, 100);
        const cashDisplay = cash >= 0 ? `+${cash}` : `${cash}`;
        this.logMessage(`Outcome: ${outcomeText} (Cash: $${cashDisplay}, Laptop: ${laptop}%, Mental: ${mental}%)`, 'text-blue-600');
        this.checkGameOver();
    }
    
    checkGameOver() {
        if (this.cash <= 0) { this.game_over_reason = "You ran out of cash."; this.is_alive = false; }
        if (this.laptop_health <= 0) { this.game_over_reason = "Your laptop failed."; this.is_alive = false; }
        if (this.mental_health <= 0) { this.game_over_reason = "You burned out."; this.is_alive = false; }
        return !this.is_alive;
    }

    logMessage(text, colorClass = 'text-gray-800') {
        const log = document.getElementById('log-area');
        const p = document.createElement('p');
        p.className = `text-sm mb-1 ${colorClass}`;
        p.textContent = text;
        if (log) log.prepend(p);
    }
}

let player;
let isProcessing = false;
let currentScenario = null; 

function rollForTravel() {
    if (isProcessing || !player.is_alive) return;
    isProcessing = true;
    
    const scenarioDisplay = document.getElementById('scenario-display');
    const scenarioControls = document.getElementById('scenario-controls');
    
    if (scenarioDisplay) scenarioDisplay.innerHTML = '<p class="text-lg text-indigo-700 font-semibold">Traveling...</p>';
    if (scenarioControls) scenarioControls.innerHTML = ''; 
    
    const distanceTraveled = Math.floor(Math.random() * 300) + 100;
    const cost = Math.floor(Math.random() * 150) + 50;
    player.distance += distanceTraveled;
    player.applyEffect(-cost, -2, -5, `Traveled ${distanceTraveled} miles.`);
    updateUI();
    
    if (player.is_alive && player.distance < TOTAL_DISTANCE) {
        fetchScenarioFromAI();
    } else {
        updateUI(); 
    }
}

async function fetchScenarioFromAI() {
    isProcessing = true;
    try {
        const response = await fetch('/api/generate-scenario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_profession: player.profession })
        });

        if (!response.ok) throw new Error(`API error: ${response.status}`);
        const data = await response.json();
        
        // --- THE KEY FIX IS HERE ---
        // This ensures the frontend accepts "scenario_text", "text", or "description"
        const text = data.scenario_text || data.text || data.description;
        const opts = data.options || data.choices;

        if (!text || !opts) throw new Error("Missing JSON fields");

        currentScenario = {
            text: text,
            options: opts.map(o => {
                // If options are just strings from AI, convert them to objects
                if (typeof o === 'string') {
                    return { text: o, cash: -20, laptop: -5, mental: 5, outcome: "You handled the situation." };
                }
                return o;
            })
        };
        
    } catch (error) {
        player.logMessage(`AI Error: ${error.message}. Using fallback.`, 'text-red-600');
        currentScenario = {
            text: "A technical glitch occurred. You must troubleshoot now.",
            options: [
                { text: "Fix it quickly", cash: -50, laptop: 5, mental: 0, outcome: "Patched successfully." },
                { text: "Ignore and rest", cash: 0, laptop: -10, mental: 10, outcome: "Feeling refreshed but buggy." }
            ]
        };
    }
    displayCurrentScenario();
    isProcessing = false;
}

function displayCurrentScenario() {
    if (!currentScenario) return; 
    const scenarioDisplay = document.getElementById('scenario-display');
    const scenarioControls = document.getElementById('scenario-controls');
    const travelButton = document.getElementById('travel-button');

    scenarioDisplay.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-indigo-800">New Stop: Decision Required</h3><p class="text-gray-700">${currentScenario.text}</p>`;
    scenarioControls.innerHTML = ''; 

    currentScenario.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option.text;
        button.className = 'w-full px-4 py-2 mb-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 shadow-md';
        button.onclick = () => handleScenarioChoice(index); 
        scenarioControls.appendChild(button);
    });
    
    if (travelButton) {
        travelButton.disabled = true;
        travelButton.style.opacity = '0.5';
    }
    updateUI();
}

function handleScenarioChoice(choiceIndex) {
    const choice = currentScenario.options[choiceIndex];
    player.applyEffect(choice.cash || 0, choice.laptop || 0, choice.mental || 0, choice.outcome || "Action taken.");
    
    const travelButton = document.getElementById('travel-button');
    if (travelButton) {
        travelButton.disabled = false;
        travelButton.style.opacity = '1';
        travelButton.style.backgroundColor = '#16a34a';
    }
    document.getElementById('scenario-controls').innerHTML = '';
    updateUI();
}

function updateUI() {
    document.getElementById('cash-value').textContent = `$${player.cash}`; 
    document.getElementById('laptop-fill').style.width = `${player.laptop_health}%`;
    document.getElementById('laptop-label').textContent = `Laptop: ${player.laptop_health}%`;
    document.getElementById('mental-fill').style.width = `${player.mental_health}%`;
    document.getElementById('mental-label').textContent = `Mental: ${player.mental_health}%`;
    
    const progress = (player.distance / TOTAL_DISTANCE) * 100;
    document.getElementById('progress-fill').style.width = `${progress}%`;
    document.getElementById('distance-value').textContent = `${player.distance} / ${TOTAL_DISTANCE} miles`;
    
    document.getElementById('status-info').innerHTML = `<div class="font-bold text-2xl text-indigo-700">${player.profession}</div>`;

    if (player.distance >= TOTAL_DISTANCE && player.is_alive) endGame(true);
    else if (!player.is_alive) endGame(false);
}

function endGame(isWin) {
    const title = isWin ? "CONGRATULATIONS!" : "GAME OVER.";
    document.getElementById('scenario-display').innerHTML = `<h2 class="text-3xl font-bold">${title}</h2><button onclick="location.reload()" class="bg-blue-500 text-white p-2 mt-4 rounded">Restart</button>`;
}

function initializeGameLayout() {
    document.getElementById('game-area').innerHTML = `
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-6">The 2025 AI Nomad Trail</h1>
            <div id="status-info" class="mb-6"></div>
            <div class="